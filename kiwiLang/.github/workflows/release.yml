name: Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-rc*'
      - 'v*.*.*-beta*'
      - 'v*.*.*-alpha*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  CACHE_VERSION: v2

jobs:
  build-and-test:
    name: Build and Test (${{ matrix.os }} - ${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        build_type: [Release]
        include:
          - os: ubuntu-latest
            artifact_name: linux-x64
            cmake_generator: Ninja
            cmake_flags: -DCMAKE_C_COMPILER=gcc-12 -DCMAKE_CXX_COMPILER=g++-12
          - os: windows-latest
            artifact_name: windows-x64
            cmake_generator: Visual Studio 17 2022
            cmake_flags: -A x64
          - os: macos-latest
            artifact_name: macos-x64
            cmake_generator: Ninja
            cmake_flags: -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Extract version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "VERSION_MAJOR=${VERSION%%.*}" >> $GITHUB_OUTPUT
        echo "VERSION_MINOR=${VERSION%.*}" >> $GITHUB_OUTPUT
        echo "VERSION_PATCH=${VERSION##*.}" >> $GITHUB_OUTPUT

    - name: Setup build environment
      shell: bash
      run: |
        if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
          sudo apt-get update
          sudo apt-get install -y gcc-12 g++-12 ninja-build
        elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
          brew install ninja
        fi

    - name: Configure CMake
      shell: bash
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DkiwiLang_ENABLE_TESTS=ON \
          -DkiwiLang_ENABLE_EXAMPLES=ON \
          -DkiwiLang_ENABLE_BENCHMARKS=OFF \
          -DkiwiLang_ENABLE_ASSERTIONS=OFF \
          -DkiwiLang_INSTALL=ON \
          ${{ matrix.cmake_flags }} \
          -G "${{ matrix.cmake_generator }}"

    - name: Build
      shell: bash
      run: |
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          cmake --build build --config ${{ matrix.build_type }} -- /m
        else
          cmake --build build --config ${{ matrix.build_type }} -- -j$(nproc)
        fi

    - name: Run tests
      shell: bash
      run: |
        cd build
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          ctest --output-on-failure -C ${{ matrix.build_type }}
        else
          ctest --output-on-failure -C ${{ matrix.build_type }} -j$(nproc)
        fi

    - name: Install
      shell: bash
      run: |
        mkdir -p install
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          cmake --install build --config ${{ matrix.build_type }} --prefix install
        else
          DESTDIR=$(pwd)/install cmake --install build --config ${{ matrix.build_type }}
        fi

    - name: Create package
      shell: bash
      run: |
        cd install
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          7z a -tzip ../kiwiLang-${{ steps.get_version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip *
        else
          tar -czf ../kiwiLang-${{ steps.get_version.outputs.VERSION }}-${{ matrix.artifact_name }}.tar.gz *
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: kiwiLang-${{ steps.get_version.outputs.VERSION }}-${{ matrix.artifact_name }}
        path: kiwiLang-${{ steps.get_version.outputs.VERSION }}-${{ matrix.artifact_name }}.*

  create-source-package:
    name: Create Source Package
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Extract version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

    - name: Create source archive
      run: |
        git archive --format=tar.gz \
          --prefix=kiwiLang-${{ steps.get_version.outputs.VERSION }}/ \
          -o kiwiLang-${{ steps.get_version.outputs.VERSION }}.tar.gz \
          HEAD

    - name: Create source archive with submodules
      run: |
        git archive --format=tar.gz \
          --prefix=kiwiLang-${{ steps.get_version.outputs.VERSION }}/ \
          -o kiwiLang-${{ steps.get_version.outputs.VERSION }}-full.tar.gz \
          HEAD
        git submodule foreach --recursive \
          'git archive --prefix=kiwiLang-${{ steps.get_version.outputs.VERSION }}/$path/ HEAD | tar -x -C /tmp'
        tar -czf kiwiLang-${{ steps.get_version.outputs.VERSION }}-full.tar.gz -C /tmp kiwiLang-${{ steps.get_version.outputs.VERSION }}

    - name: Upload source artifacts
      uses: actions/upload-artifact@v3
      with:
        name: source-packages
        path: |
          kiwiLang-${{ steps.get_version.outputs.VERSION }}.tar.gz
          kiwiLang-${{ steps.get_version.outputs.VERSION }}-full.tar.gz

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Extract version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "VERSION_MAJOR=${VERSION%%.*}" >> $GITHUB_OUTPUT
        echo "VERSION_MINOR=${VERSION%.*}" >> $GITHUB_OUTPUT
        echo "VERSION_PATCH=${VERSION##*.}" >> $GITHUB_OUTPUT

    - name: Log in to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push base image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: docker/Dockerfile.base
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push dev image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: docker/Dockerfile.dev
        push: true
        tags: ${{ steps.meta.outputs.tags }}-dev
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push minimal image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: docker/Dockerfile.minimal
        push: true
        tags: ${{ steps.meta.outputs.tags }}-minimal
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-and-test, create-source-package]
    permissions:
      contents: write

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Extract version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

    - name: Generate changelog
      run: |
        echo "# kiwiLang ${{ steps.get_version.outputs.VERSION }}" > RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "## Changes" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        git log --pretty=format:"- %s" $(git describe --tags --abbrev=0)..HEAD >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "## Installation" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### Binary Packages" >> RELEASE_NOTES.md
        echo "- **Linux**: [kiwiLang-${{ steps.get_version.outputs.VERSION }}-linux-x64.tar.gz](kiwiLang-${{ steps.get_version.outputs.VERSION }}-linux-x64.tar.gz)" >> RELEASE_NOTES.md
        echo "- **Windows**: [kiwiLang-${{ steps.get_version.outputs.VERSION }}-windows-x64.zip](kiwiLang-${{ steps.get_version.outputs.VERSION }}-windows-x64.zip)" >> RELEASE_NOTES.md
        echo "- **macOS**: [kiwiLang-${{ steps.get_version.outputs.VERSION }}-macos-x64.tar.gz](kiwiLang-${{ steps.get_version.outputs.VERSION }}-macos-x64.tar.gz)" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### Source Packages" >> RELEASE_NOTES.md
        echo "- [kiwiLang-${{ steps.get_version.outputs.VERSION }}.tar.gz](kiwiLang-${{ steps.get_version.outputs.VERSION }}.tar.gz) (without submodules)" >> RELEASE_NOTES.md
        echo "- [kiwiLang-${{ steps.get_version.outputs.VERSION }}-full.tar.gz](kiwiLang-${{ steps.get_version.outputs.VERSION }}-full.tar.gz) (with submodules)" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### Docker" >> RELEASE_NOTES.md
        echo "```bash" >> RELEASE_NOTES.md
        echo "docker pull ghcr.io/kiwiLanglang/kiwiLang:${{ steps.get_version.outputs.VERSION }}" >> RELEASE_NOTES.md
        echo "docker pull ghcr.io/kiwiLanglang/kiwiLang:${{ steps.get_version.outputs.VERSION }}-dev" >> RELEASE_NOTES.md
        echo "docker pull ghcr.io/kiwiLanglang/kiwiLang:${{ steps.get_version.outputs.VERSION }}-minimal" >> RELEASE_NOTES.md
        echo "```" >> RELEASE_NOTES.md

    - name: Collect release assets
      run: |
        find . -name "*.tar.gz" -o -name "*.zip" | xargs -I {} mv {} .
        ls -la *.tar.gz *.zip

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: kiwiLang ${{ steps.get_version.outputs.VERSION }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
        files: |
          kiwiLang-*.tar.gz
          kiwiLang-*.zip

  publish-homebrew:
    name: Publish to Homebrew
    runs-on: ubuntu-latest
    needs: create-release
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-')

    steps:
    - name: Checkout homebrew tap
      uses: actions/checkout@v4
      with:
        repository: kiwiLanglang/homebrew-tap
        token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        path: homebrew-tap

    - name: Extract version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

    - name: Update formula
      run: |
        cd homebrew-tap
        SHA256=$(curl -sL https://github.com/kiwiLanglang/kiwiLang/releases/download/v${{ steps.get_version.outputs.VERSION }}/kiwiLang-${{ steps.get_version.outputs.VERSION }}.tar.gz | shasum -a 256 | cut -d' ' -f1)
        sed -i.bak \
          -e "s/version \".*\"/version \"${{ steps.get_version.outputs.VERSION }}\"/" \
          -e "s/sha256 \".*\"/sha256 \"$SHA256\"/" \
          Formula/kiwiLang.rb
        rm Formula/kiwiLang.rb.bak

    - name: Commit and push
      run: |
        cd homebrew-tap
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add Formula/kiwiLang.rb
        git commit -m "kiwiLang ${{ steps.get_version.outputs.VERSION }}"
        git push

  publish-vcpkg:
    name: Publish to vcpkg
    runs-on: ubuntu-latest
    needs: create-release
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-')

    steps:
    - name: Checkout vcpkg registry
      uses: actions/checkout@v4
      with:
        repository: kiwiLanglang/vcpkg-registry
        token: ${{ secrets.VCPKG_REGISTRY_TOKEN }}
        path: vcpkg-registry

    - name: Extract version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

    - name: Update portfile
      run: |
        cd vcpkg-registry
        SHA512=$(curl -sL https://github.com/kiwiLanglang/kiwiLang/releases/download/v${{ steps.get_version.outputs.VERSION }}/kiwiLang-${{ steps.get_version.outputs.VERSION }}.tar.gz | shasum -a 512 | cut -d' ' -f1)
        cat > ports/kiwiLang/v${{ steps.get_version.outputs.VERSION }}.json << EOF
        {
          "name": "kiwiLang",
          "version-string": "${{ steps.get_version.outputs.VERSION }}",
          "port-version": 0,
          "description": "The Kiwi Programming Language",
          "homepage": "https://github.com/kiwiLanglang/kiwiLang",
          "license": "MIT",
          "dependencies": [
            "catch2",
            "fmt",
            "spdlog"
          ],
          "features": {
            "llvm": {
              "description": "Enable LLVM backend",
              "dependencies": ["llvm"]
            },
            "jit": {
              "description": "Enable JIT compilation",
              "dependencies": ["llvm"]
            }
          },
          "default-features": ["llvm", "jit"]
        }
        EOF

    - name: Commit and push
      run: |
        cd vcpkg-registry
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add ports/kiwiLang/v${{ steps.get_version.outputs.VERSION }}.json
        git commit -m "kiwiLang ${{ steps.get_version.outputs.VERSION }}"
        git push

  notify:
    name: Notify Community
    runs-on: ubuntu-latest
    needs: [create-release, publish-homebrew, publish-vcpkg]
    if: always()

    steps:
    - name: Extract version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

    - name: Send Discord notification
      if: success()
      uses: Ilshidur/action-discord@0.3.2
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      with:
        args: 'üöÄ **kiwiLang ${{ steps.get_version.outputs.VERSION }} Released!**\n\nüì¶ Download: https://github.com/kiwiLanglang/kiwiLang/releases/tag/v${{ steps.get_version.outputs.VERSION }}\nüê≥ Docker: `docker pull ghcr.io/kiwiLanglang/kiwiLang:${{ steps.get_version.outputs.VERSION }}`\nüç∫ Homebrew: `brew install kiwiLanglang/tap/kiwiLang`\nüìö Docs: https://kiwiLanglang.github.io/kiwiLang/'

    - name: Send failure notification
      if: failure()
      uses: Ilshidur/action-discord@0.3.2
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      with:
        args: '‚ùå **Release ${{ steps.get_version.outputs.VERSION }} failed!**\n\nCheck the logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Clean up artifacts
      run: |
        rm -rf kiwiLang-*.tar.gz kiwiLang-*.zip RELEASE_NOTES.md