name: CI

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  BUILD_TYPE: Release
  CACHE_VERSION: v1

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc-12, clang-15]
        build_type: [Debug, Release]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Cache ccache
      uses: actions/cache@v3
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ matrix.compiler }}-${{ env.CACHE_VERSION }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-${{ matrix.compiler }}-${{ env.CACHE_VERSION }}-
          
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ${{ matrix.compiler }} \
          lld \
          ninja-build \
          ccache \
          python3 \
          python3-pip \
          clang-format \
          clang-tidy \
          doxygen \
          graphviz \
          plantuml
        
    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build \
          -DCMAKE_CXX_COMPILER=${{ matrix.compiler }} \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_CXX_FLAGS="-Werror" \
          -DkiwiLang_ENABLE_TESTS=ON \
          -DkiwiLang_ENABLE_EXAMPLES=ON \
          -DkiwiLang_ENABLE_BENCHMARKS=OFF \
          -DkiwiLang_ENABLE_ASSERTIONS=${{ matrix.build_type == 'Debug' && 'ON' || 'OFF' }} \
          -G Ninja
          
    - name: Build
      run: |
        cmake --build ${{github.workspace}}/build --config ${{ matrix.build_type }} -j$(nproc)
        
    - name: Run tests
      run: |
        cd ${{github.workspace}}/build
        ctest --output-on-failure -C ${{ matrix.build_type }} -j$(nproc)
        
    - name: Run clang-tidy
      if: matrix.compiler == 'clang-15'
      run: |
        cd ${{github.workspace}}/build
        cmake --build . --target kiwiLang -- -j$(nproc) 2>&1 | grep -E "(warning|error):" && exit 1 || true
        
  build-windows:
    runs-on: windows-latest
    
    strategy:
      matrix:
        build_type: [Debug, Release]
        
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DkiwiLang_ENABLE_TESTS=ON \
          -DkiwiLang_ENABLE_EXAMPLES=ON \
          -DkiwiLang_USE_LLVM=OFF \
          -DkiwiLang_ENABLE_JIT=OFF \
          -A x64
          
    - name: Build
      run: |
        cmake --build ${{github.workspace}}/build --config ${{ matrix.build_type }} -- /m
        
    - name: Run tests
      run: |
        cd ${{github.workspace}}/build
        ctest --output-on-failure -C ${{ matrix.build_type }}
        
  build-macos:
    runs-on: macos-latest
    
    strategy:
      matrix:
        build_type: [Debug, Release]
        
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Install dependencies
      run: |
        brew install cmake ninja ccache
        
    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_CXX_FLAGS="-Werror" \
          -DkiwiLang_ENABLE_TESTS=ON \
          -DkiwiLang_ENABLE_EXAMPLES=ON \
          -DkiwiLang_ENABLE_ASSERTIONS=${{ matrix.build_type == 'Debug' && 'ON' || 'OFF' }} \
          -G Ninja
          
    - name: Build
      run: |
        cmake --build ${{github.workspace}}/build --config ${{ matrix.build_type }} -j$(sysctl -n hw.ncpu)
        
    - name: Run tests
      run: |
        cd ${{github.workspace}}/build
        ctest --output-on-failure -C ${{ matrix.build_type }} -j$(sysctl -n hw.ncpu)
        
  code-quality:
    runs-on: ubuntu-latest
    needs: [build-linux]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-format \
          clang-tidy \
          cppcheck \
          python3 \
          python3-pip
        pip3 install codespell
        
    - name: Check formatting
      run: |
        find . -name "*.cpp" -o -name "*.h" -o -name "*.hpp" | \
          xargs clang-format --dry-run --Werror
          
    - name: Run cppcheck
      run: |
        cppcheck --enable=all --suppress=missingIncludeSystem \
          --inline-suppr --error-exitcode=1 \
          -I include -I third_party/catch2 \
          src tests tools 2> cppcheck.txt
        
    - name: Check spelling
      run: |
        codespell --skip="*.json,*.sqlite,*.profraw,*.profdata,*.gcov,*.gcda,*.gcno" \
          --ignore-words-list="crate,uint,fo,te,nd,iif,helo,unparse"
          
    - name: Check for TODOs
      run: |
        ! grep -r "TODO\|FIXME\|XXX\|HACK" --include="*.cpp" --include="*.h" --include="*.hpp" \
          --include="*.cmake" --include="CMakeLists.txt" src include tests
        
  documentation:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          doxygen \
          graphviz \
          plantuml \
          python3 \
          python3-pip
        pip3 install mkdocs mkdocs-material
        
    - name: Generate documentation
      run: |
        python3 tools/scripts/update_docs.py
        doxygen docs/Doxyfile
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/doxygen/html
        destination_dir: ./api
        
  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'kiwiLang'
        path: '.'
        format: 'HTML'
        args: >
          --failOnCVSS 7
          --enableRetired
          
    - name: Upload security report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-check-report
        path: dependency-check-report.html
        
  benchmarks:
    runs-on: ubuntu-latest
    needs: [build-linux]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Build benchmark configuration
      run: |
        cmake -B ${{github.workspace}}/build-bench \
          -DCMAKE_BUILD_TYPE=Release \
          -DkiwiLang_ENABLE_BENCHMARKS=ON \
          -DkiwiLang_ENABLE_TESTS=OFF \
          -G Ninja
        cmake --build ${{github.workspace}}/build-bench --config Release -j$(nproc)
        
    - name: Run benchmarks
      run: |
        python3 tools/scripts/benchmark.py \
          --build-dir ${{github.workspace}}/build-bench \
          --output-dir ${{github.workspace}}/benchmark_results \
          --plot
        
    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: benchmark-results
        path: |
          ${{github.workspace}}/benchmark_results
          ${{github.workspace}}/benchmark_results/plots
        
  coverage:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-12 g++-12 \
          lcov \
          ninja-build
        
    - name: Configure for coverage
      run: |
        cmake -B ${{github.workspace}}/build-coverage \
          -DCMAKE_CXX_COMPILER=g++-12 \
          -DCMAKE_BUILD_TYPE=Debug \
          -DkiwiLang_ENABLE_COVERAGE=ON \
          -DkiwiLang_ENABLE_TESTS=ON \
          -DkiwiLang_ENABLE_ASSERTIONS=ON \
          -G Ninja
          
    - name: Build
      run: |
        cmake --build ${{github.workspace}}/build-coverage --config Debug -j$(nproc)
        
    - name: Generate coverage
      run: |
        cd ${{github.workspace}}/build-coverage
        ctest --output-on-failure -j$(nproc)
        lcov --directory . --capture --output-file coverage.info
        lcov --remove coverage.info '*/tests/*' '*/third_party/*' --output-file coverage.info
        lcov --list coverage.info
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ${{github.workspace}}/build-coverage/coverage.info
        flags: unittests
        
  package:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Get version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        
    - name: Create Linux package
      run: |
        mkdir -p packages/linux
        cmake -B build-linux-release \
          -DCMAKE_BUILD_TYPE=Release \
          -DkiwiLang_ENABLE_TESTS=OFF \
          -DkiwiLang_ENABLE_EXAMPLES=OFF \
          -DkiwiLang_INSTALL=ON \
          -G Ninja
        cmake --build build-linux-release --config Release --target install -- DESTDIR=packages/linux
        tar -czf kiwiLang-${{ steps.get_version.outputs.VERSION }}-linux-x64.tar.gz -C packages/linux .
        
    - name: Create source package
      run: |
        git archive --format=tar.gz --prefix=kiwiLang-${{ steps.get_version.outputs.VERSION }}/ \
          -o kiwiLang-${{ steps.get_version.outputs.VERSION }}.tar.gz HEAD
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          kiwiLang-*.tar.gz
        draft: false
        prerelease: false
        
  notify:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    if: failure()
    
    steps:
    - name: Notify failure
      run: |
        echo "CI pipeline failed. Check the logs for details."
        # In real project, would send to Slack/Discord/etc.
        
  matrix-summary:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, code-quality, security, benchmarks]
    
    steps:
    - name: Summary
      run: |
        echo "CI Pipeline Summary"
        echo "==================="
        echo "All checks completed."
        echo ""
        echo "Successful jobs:"
        echo "- Build (Linux GCC/Clang Debug/Release)"
        echo "- Build (Windows Debug/Release)"
        echo "- Build (macOS Debug/Release)"
        echo "- Code Quality"
        echo "- Security Scan"
        echo "- Benchmarks"
        echo ""
        echo "Ready for merge!"